#!/usr/bin/env bash
#MISE description="Show Hammerspoon console logs"
#USAGE flag "-n --lines <count>" help="Number of lines to show" default="50"
#USAGE flag "-e --errors" help="Show only errors"

set -e

TASKS_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$TASKS_DIR/_hs"

LINES="${usage_lines}"
ERRORS="${usage_errors:-false}"

# Try IPC first, fall back to macOS unified log
# Note: hs.console.getConsole() returns console window contents, which
# may be empty if the console was never opened in this session.
IPC_OK=false
if timeout 3 "$HS_CLI" -c "return [[ok]]" >/dev/null 2>&1; then
    IPC_OK=true
    OUTPUT=$(hs_run "return hs.console.getConsole()" 2>/dev/null || echo "")
fi

if [ "$IPC_OK" = "true" ]; then
    if [ -z "$OUTPUT" ]; then
        echo "(console output is empty)"
    elif [ "$ERRORS" = "true" ]; then
        echo "$OUTPUT" | tail -n "$LINES" | grep -i "error" || echo "(no errors in last $LINES lines)"
    else
        echo "$OUTPUT" | tail -n "$LINES"
    fi
else
    echo "(IPC unavailable â€” falling back to macOS unified log)" >&2
    LOG_CMD="log show --process Hammerspoon --last 5m --style compact"
    if [ "$ERRORS" = "true" ]; then
        $LOG_CMD 2>/dev/null | grep -i "error" | tail -n "$LINES" || echo "(no errors found)"
    else
        $LOG_CMD 2>/dev/null | tail -n "$LINES"
    fi
fi
