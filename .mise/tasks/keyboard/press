#!/usr/bin/env bash
#MISE description="Press a key combination"
#USAGE arg "<key>" help="Key name (e.g. v, return, escape, tab, space, f1)"
#USAGE flag "--mod... <mod>" help="Modifier: cmd, ctrl, alt, shift (repeatable)"

set -e

TASKS_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$TASKS_DIR/_hs"
hs_check

KEY="${usage_key:?key required}"

# Validate key name (alphanumeric, function keys, named keys)
if ! echo "$KEY" | grep -qE '^[a-zA-Z0-9]+$'; then
    echo "error: invalid key name: $KEY" >&2
    exit 1
fi

# Build modifiers table
MODS="{"
if [ -n "${usage_mod+x}" ]; then
    FIRST=true
    for MOD in "${usage_mod[@]}"; do
        case "$MOD" in
            cmd|ctrl|alt|shift) ;;
            *) echo "error: invalid modifier: $MOD (use cmd, ctrl, alt, shift)" >&2; exit 1 ;;
        esac
        if [ "$FIRST" = true ]; then
            MODS+="\"$MOD\""
            FIRST=false
        else
            MODS+=", \"$MOD\""
        fi
    done
fi
MODS+="}"

# Use newKeyEventSequence + post instead of keyStroke to avoid its
# internal timer delay which hangs the hs CLI.
hs_run "
local events = hs.eventtap.event.newKeyEventSequence(${MODS}, '${KEY}')
for _, e in ipairs(events) do e:post() end
return [[ok]]
" > /dev/null
